- name: Get timestamp
  shell: date
  register: timestamp
  delegate_to: localhost

- name: Make sure we're in the right branch
  shell: git checkout {{git_branch|default('master')}}
  args:
    chdir: "{{ git_repository }}"
  delegate_to: localhost
  ignore_errors: yes

- name: Pull remote changes
  shell: git pull
  args:
    chdir: "{{ git_repository }}"
  delegate_to: localhost

- name: Check the directory status
  shell: git status
  args:
    chdir: "{{ git_repository }}"
  register: changes
  delegate_to: localhost

- name: "Add files to Git staging area, commit and push"
  shell: |
    git add .
    git commit -m "Configuration changed on {{ timestamp.stdout }}"
    git push --set-upstream origin {{ git_branch|default('master') }}
  args:
    chdir: "{{ git_repository }}"
  when: not("working directory clean" in changes.stdout)
  delegate_to: localhost